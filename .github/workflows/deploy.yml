name: Deploy Finn Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy target (production|staging)"
        required: false
        default: "production"

env:
  APP_NAME: finn-backend
  BUILD_DIR: springboot
  JAR_OUTPUT: springboot/build/libs

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build and test
        run: |
          cd $BUILD_DIR
          ./gradlew clean test bootJar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: finn-backend-jar
          path: ${{ env.JAR_OUTPUT }}/*.jar

  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: finn-backend-jar
          path: artifact

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare SSH key
        run: |
          install -m 600 -D <<<"${{ secrets.VM_SSH_KEY }}" ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts

      - name: Upload artifact to server
        run: |
          scp -i ~/.ssh/id_ed25519 artifact/*.jar ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:${{ secrets.VM_PROJECT_DIR }}/repo/springboot/build/libs/finn-backend.jar

      - name: Remote deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -euo pipefail
            export PROJECT_DIR="${{ secrets.VM_PROJECT_DIR }}"
            cd "$PROJECT_DIR/repo"
            sudo -u finnbbackend git fetch origin main
            sudo -u finnbbackend git reset --hard origin/main
            sudo -u finnbbackend bash -lc 'cd /opt/finn-backend/repo/springboot && ./gradlew --no-daemon bootJar'
            sudo -u finnbbackend ln -sf /opt/finn-backend/repo/springboot/build/libs/finn-backend.jar /opt/finn-backend/repo/springboot/build/libs/finn-backend-latest.jar
            sudo -u finnbbackend pm2 reload /opt/finn-backend/ecosystem.config.js --env production || sudo -u finnbbackend pm2 start /opt/finn-backend/ecosystem.config.js --env production
            sudo -u finnbbackend pm2 save
            /opt/finn-backend/scripts/healthcheck.sh "https://${{ secrets.DOMAIN_PROD }}/healthz"

      - name: Record last good commit
        if: success()
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: echo "${GITHUB_SHA}" | sudo tee ${{ secrets.VM_PROJECT_DIR }}/repo/.last_good_commit

  deploy-staging:
    needs: build-test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    env:
      STAGING_ENV: staging
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: finn-backend-jar
          path: artifact

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare SSH key
        run: |
          install -m 600 -D <<<"${{ secrets.STAGING_VM_SSH_KEY }}" ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.STAGING_VM_IP }} >> ~/.ssh/known_hosts

      - name: Upload artifact to staging server
        run: |
          scp -i ~/.ssh/id_ed25519 artifact/*.jar ${{ secrets.STAGING_VM_USER }}@${{ secrets.STAGING_VM_IP }}:${{ secrets.STAGING_VM_PROJECT_DIR }}/repo/springboot/build/libs/finn-backend.jar

      - name: Remote staging deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_VM_IP }}
          username: ${{ secrets.STAGING_VM_USER }}
          key: ${{ secrets.STAGING_VM_SSH_KEY }}
          script: |
            set -euo pipefail
            export PROJECT_DIR="${{ secrets.STAGING_VM_PROJECT_DIR }}"
            cd "$PROJECT_DIR/repo"
            sudo -u finnbbackend git fetch origin main
            sudo -u finnbbackend git reset --hard origin/main
            sudo -u finnbbackend bash -lc 'cd /opt/finn-backend/repo/springboot && ./gradlew --no-daemon bootJar'
            sudo -u finnbbackend ln -sf /opt/finn-backend/repo/springboot/build/libs/finn-backend.jar /opt/finn-backend/repo/springboot/build/libs/finn-backend-latest.jar
            sudo -u finnbbackend pm2 reload /opt/finn-backend/ecosystem.config.js --env staging || sudo -u finnbbackend pm2 start /opt/finn-backend/ecosystem.config.js --env staging
            sudo -u finnbbackend pm2 save
            /opt/finn-backend/scripts/healthcheck.sh "https://${{ secrets.DOMAIN_STAGING }}/healthz"
